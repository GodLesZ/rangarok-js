<!doctype html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=1, user-scalable=no" />
		
		<script src="common.js"></script>
		<script src="prototype.js"></script>
		
		<script src="settings.js"></script>
		
		<script src="Tables/mp3nametable.js"></script>
		<script src="Tables/fogparametertable.js"></script>
		<script src="Tables/ClassResNameTable.js"></script>
		<script src="Tables/pcjobtable.js"></script>
		<script src="Tables/AccessoryIdTable.js"></script>
		<script src="Tables/AccessoryNameTable.js"></script>
		<script src="Tables/HeadIdTable.js"></script>
		<script src="SoundPlayer.js"></script>
		
		<script src="FileFormat/rsm.js"></script>
		<script src="FileFormat/gat.js"></script>
		<script src="FileFormat/gnd.js"></script>
		<script src="FileFormat/rsw.js"></script>
		<script src="FileFormat/sprparser.js"></script>
		<script src="FileFormat/actparser.js"></script>
		
		<script src="include/three.58.js"></script>
		<script src="include/ReusableRay.js"></script>
		<script src="include/CustomControls.js"></script>
		
		<script src="Deferred.js"></script>
		
		<script src="ResourceLoader.js"></script>
		<script src="MapLoader.js"></script>
		
		<script src="SpriteActor.js"></script>
		
	</head>
	
	<style>
	
	canvas {
		display: block;
	}
	
	html, body {
		width: 100%;
		height: 100%;
	}
	
	body {
		background: url("load_kr/loading02.jpg") no-repeat center center fixed;
		background-size: cover;
	}
	
	* {
		padding: 0;
		margin: 0;
	}
	
	</style>
	
	<body>
	
	<script>

'use strict';

var webGlTest = function() {
	
	if (!window.WebGLRenderingContext) {
		return false; 
	}

	var gl = document.createElement("canvas").getContext("webgl")
		|| document.createElement("canvas").getContext("experimental-webgl");
	
	if(!gl) {
		return false;
	}
	
	return true;
}

window.onload = function() {

	var e0 = window.navigator.userAgent.match("((Chrom(e|(ium)))|(Firefox))/2[0-9]") == null;
	var e1 = !webGlTest();
	
	
	var skip = location.href.match('compatibility-ignore');
	
	if((e0 || e1) && !skip) {
		
		window.document.body.style.background = "#eeeeee";
	
		var msg1 = (e0 && "Incompatible browser") || (e1 && "WebGL not supported");
		var msg2 = (e0 && "<p>This demo requires a recent version of Google Chrome or Mozilla Firefox. Sorry about that!</p><p>Please upgrade your browser and come back.</p>")
			|| (e1 && "<p>Your computer does not seem to support WebGL. Find out more at <a style='text-decoration: none' href='http://get.webgl.org/'>get.webgl.org</a></p>");
	
		window.document.body.innerHTML = "\
		<div style='position: absolute; top: 25%; left: 10%; width: 80%; height: 50%; line-height: 3em;'>\
			<div style='font-family: helvetica, calibri; padding: 10px;'>\
				<span style='font-size: 5em; font-family: helvetica, calibri; color: #666666;'>" + msg1 + "</span><br />\
				<div style='margin-top: 1em; max-width: 80%;'>\
					<span style='font-size: 2em;;'>" + msg2 + "</span>\
				</div>\
				<div style='max-width: 80%;'>\
					<span style='font-size: 1em; font-weight: bold;'>Want to try anyway? <a style='text-decoration: none' href='?compatibility-ignore'>Click here.</a></span>\
				</div>\
			</div>\
		\
		</div>";
		
	} else {
		start();
	}

};

var start = function() {
	
	//<script>
	
	//var width = window.innerWidth;
	//var height = window.innerHeight;
	
	//var renderer = this.renderer = new THREE.WebGLRenderer({
	//	antialias: true
	//});
	
	//var scene = this.scene = new THREE.Scene();
	
	//var viewAngle = 45;
	//var viewAngle = -340;
	//var viewAngle = 20;
	
	//var camera = this.camera = new THREE.PerspectiveCamera( viewAngle, width / height, 0.1, 10000 );
	
	//renderer.setClearColor(0x000000);
	
	//renderer.setSize(width, height);
	
	//var a = new THREE.AxisHelper();
	
	//a.scale = new THREE.Vector3(100, 100, 100);
	
	//scene.add(a);
	
	//camera.position.set(0, 20, 20);
	//camera.lookAt(new THREE.Vector3(0,0,0));
	
	//var geometry = new THREE.Geometry();
	//var warpGeometry = new THREE.SphereGeometry(10, 20, 20);
	
	//for(var p = 0, d = 0; d < 4; d++) {
	//	for(i = 0; i < 360; i += 30) {
			
	//		var x0 = Math.cos(i * Math.PI / 180);
	//		var y0 = Math.sin(i * Math.PI / 180);
	//		var x1 = Math.cos((i + 30) * Math.PI / 180);
	//		var y1 = Math.sin((i + 30) * Math.PI / 180);
			
	//		var r = d * 2.0;
	//		var h = 0.5;
			
	//		geometry.vertices.push(new THREE.Vector3(x0 * d, 0, y0 * d));
	//		geometry.vertices.push(new THREE.Vector3(x0 * r, h, y0 * r));
	//		geometry.vertices.push(new THREE.Vector3(x1 * r, h, y1 * r));
	//		geometry.vertices.push(new THREE.Vector3(x1 * d, 0, y1 * d));
			
	//		var face = new THREE.Face4(p, p + 1, p + 2, p + 3);
			
	//		geometry.faceVertexUvs[0].push([
	//			new THREE.Vector2( 0, 0 ),
	//			new THREE.Vector2( 0, 1 ),
	//			new THREE.Vector2( 1, 1 ),
	//			new THREE.Vector2( 1, 0 )
	//		]);
			
	//		geometry.faces.push(face);
			
	//		p += 4;
			
	//	}
	//}
	
	//geometry.faceVertexUvs[1] = geometry.faceVertexUvs[0];
	
	//var material = new THREE.MeshBasicMaterial({
	//	transparent: true,
		//color: 0xff0000,
	//	side: THREE.DoubleSide,
		//opacity: 0.5,
	//	alphaTest: 0.5,
	//	map: ResourceLoader.getTexture("effect/ring_blue.png"),
		//map: ResourceLoader.getTexture("effect/alpha_down.png"),
	//})
	
	//var mesh = new THREE.Mesh(geometry, material);
	
	//scene.add(mesh);
	
	//setInterval(function() {
	//	mesh.rotation.y += 0.01;
	//	mesh.scale.z -= 0.01;
	//	mesh.scale.x -= 0.01;
	//	if(mesh.scale.z < 0) mesh.scale.z = 1.0;
	//	if(mesh.scale.x < 0) mesh.scale.x = 1.0;
		
	//}, 25);
	
	//(function animate() {
	//	requestAnimationFrame(animate);
	//	renderer.render(scene, camera);
	//})();
	
	//document.body.appendChild(renderer.domElement);
	
	//return;
	
//SpriteActor.prototype.SetAttachment = function(attachmentType, sprFileObject, actFileObject) {
//SpriteActor.prototype.addAttachmentToScene = function(scene, attachmentType) {
	
	//ResourceLoader.createFile = function(dirName, fileName, fileData, type);
	//ResourceLoader.getFile = function(dirName, fileName, returnType);
	/*
	ResourceLoader.ready
		.then(ResourceLoader.createFile.bind(null, 
			"test", 
			"test.txt", 
			"data data data", 
			"text/plain"
		))
		.then(function(status) {
			
			console.log(status);
			
			if(status) {
			
				ResourceLoader.getFile("test", "test.txt", "text")
					.then(function(data) {
						console.log(data);
					});
			
			}
			
		});
	
	return;
	*/
	//ResourceLoader.getRsm("´ÏÇÃÇìÀÓ/´ÏÇÃÇìÀÓ-¸¶³à¼º01.rsm").then(function(data) {
	//	RsmMesh(new RSM(data));
	//});
	
	//return;
		
	window.document.body.innerHTML = "\
		<div id='b_loading' style='position: absolute; top: 50%; left: 50%; width: 64px; height: 64px; margin-left: -32px; margin-top: -32px;'>\
			<img src='assets/loading64-2.gif' />\
		</div>";//<script>
	
	var bLoading = document.getElementById("b_loading");
	
	var mapLoader = new MapLoader();
	
	window.mapLoader = mapLoader;
	
	var obj = new SpriteActor(mapLoader);
	
	var start = Date.now();
	
	var mapName = location.href.match(/map=([\w\d_]+.rsw)/i);
	
	mapLoader
		.loadMap((mapName !== null && mapName[1]) || "te_prt_gld.rsw")
		.then(function(d) {
			
			console.log("Info: Loading finished in " + (Date.now() - start) + "ms");
			
			// Hide loading stuff
			document.body.removeChild(bLoading);
			
			// Start rendering
			mapLoader.start();
			
			// Play music
			//SoundPlayer.playBGM(mp3NameTable[mapLoader.getMapName()]);
			
			// Set position
			obj.SetGatPosition(44, 136);
			
			window.s = obj;
			
			// Bind camera to player
			mapLoader.bindCamera(obj);
		})
		
		.then(lol.bind(this, obj, "sprite/ÀÎ°£Á·/¸öÅë/³²/»óÀÎ_³²", SpriteActor.Attachment.BODY))
		.then(lol.bind(this, obj, "sprite/ÀÎ°£Á·/¸Ó¸®Åë/³²/7_³²", SpriteActor.Attachment.HEAD))
		.then(lol.bind(this, obj, "sprite/shadow", SpriteActor.Attachment.SHADOW))
		//.then(lol.bind(this, obj, "sprite/¾Ç¼¼»ç¸®/³²/³²_Åä³¢¸Ó¸®¶ì", SpriteActor.Attachment.TOP))
		.then(function() {
			
			settop(AccessoryIdTable.ACCESSORY_SAHT_GAHT);
			setmid(AccessoryIdTable.ACCESSORY_ELF_SUNGLASS);
			
			setInterval(function() {
				obj.Update(mapLoader.camera);
			}, 10);
		
		});
};

function say(message) {
	s.displayMessageLabel(message);
};

function setclass(class_id) {
	lol(window.s, "sprite/ÀÎ°£Á·/¸öÅë/³²/" + ClassResNameTable[ class_id ] + "_³²", SpriteActor.Attachment.BODY);
}

function settop(accessory_id) {
	lol(window.s, "sprite/¾Ç¼¼»ç¸®/³²/³²" + AccessoryNameTable[ accessory_id ], SpriteActor.Attachment.TOP);
}

function setmid(accessory_id) {
	lol(window.s, "sprite/¾Ç¼¼»ç¸®/³²/³²" + AccessoryNameTable[ accessory_id ], SpriteActor.Attachment.MID);
}

function setbottom(accessory_id) {
	lol(window.s, "sprite/¾Ç¼¼»ç¸®/³²/³²" + AccessoryNameTable[ accessory_id ], SpriteActor.Attachment.BOTTOM);
}

function npc(npc_id, x, y) {
	var npc = spawn("sprite/npc/" + npc_id, false, x, y);
	
	npc.type = SpriteActor.Types.NPC;
	npc.name = npc_id;
	
	return npc;
}

function monster(monster_id, x, y) {
	
	var m = spawn("sprite/¸ó½ºÅÍ/" + monster_id, true, x, y);
	
	m.type = SpriteActor.Types.MONSTER;
	m.name = monster_id;
	
	return m;
}

function allplayer() {
	
	var k = 0;
	
	for(var i in ClassResNameTable) {
		setTimeout(player.bind(this, i), k * 350);
		k++;
	};
	
};

function player(class_id) {
	
	var actor = spawn("sprite/ÀÎ°£Á·/¸öÅë/³²/" + ClassResNameTable[ class_id ] + "_³²", true);
	
	lol(actor, "sprite/ÀÎ°£Á·/¸Ó¸®Åë/³²/" + HeadIdTable[1][ parseInt(Math.random() * HeadIdTable[1].length ) ] + "_³²", SpriteActor.Attachment.HEAD);
	
	actor.type = SpriteActor.Types.PLAYER;
	actor.name = "job_" + class_id;
	
	return actor;
	
};

function spawn(path, move, gat_x, gat_y) {

	var task = Deferred();
	var actor = new SpriteActor(mapLoader);
	
	gat_x = gat_x || (s.gatPosition.x + Math.round(5 - Math.random() * 10));
	gat_y = gat_y || (s.gatPosition.y + Math.round(5 - Math.random() * 10));
	
	task.then(lol.bind(this, actor, path, SpriteActor.Attachment.BODY));
	
	task.then(lol.bind(this, actor, "sprite/shadow", SpriteActor.Attachment.SHADOW));
	
	task.finally(function() {
		actor.SetGatPosition(gat_x, gat_y);
		actor.MovementSpeed = 200;
	});
	
	var lines = [
		"lol noobs!",
		"come at me bro",
		"testing....",
		"this is horrible",
		"i'm not botting....",
		"chill man its cool",
		"what?",
		"idk yo",
		"huehuehuehue",
		"brasil #1 !!!!!",
		"^___^",
		"xD that so funny",
		"like wut?",
		"hmmmmmmmmmmmm",
		"this game is stupid",
		"selling gr card 1M PM ME!!",
		"hey guys"
	];
	
	if(move) setInterval((function(obj) {
		return function() {
			
			if(Math.random() < 0.05 && obj.type == SpriteActor.Types.PLAYER) {
				obj.displayMessageLabel(obj.name + ": " + lines[ Math.round( Math.random() * (lines.length - 1) ) ]);
			}
			
			if(Math.random() < 0.5) {			
				obj.MoveToGatPosition(
					obj.gatPosition.x + Math.round(5 - Math.random() * 10),
					obj.gatPosition.y + Math.round(5 - Math.random() * 10)
				);			
			}
			
		}
	})(actor), 1500 + Math.random() * 1000);
	
	setInterval(function() {
		actor.Update(mapLoader.camera);
	}, 10);

	return actor;

};

function lol(obj, n, ttype) {

	console.log("Info: Loading attachment " + n);

	var queue = Deferred();
	
	var name = n;
	
	var sprFileObject = null;
	var actFileObject = null;
	
	// Get SPR object
	queue
		.then(ResourceLoader.getProcessedFileObject.bind(this, ResourceLoader.FileType.SPR, name + ".spr"))
		.then(function(pObj) {
			sprFileObject = pObj;
		});
	
	// Get ACT object
	queue
		.then(ResourceLoader.getProcessedFileObject.bind(this, ResourceLoader.FileType.ACT, name + ".act"))
		.then(function(pObj) {
			actFileObject = pObj;
		});
	
	// Set attachment
	return queue.finally(function() {
		obj.SetAttachment(ttype, sprFileObject, actFileObject);
		obj.addAttachmentToScene(mapLoader.scene, ttype);
	})
	
}

	</script>
	
	</body>
</html>